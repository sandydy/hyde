---
layout: post
title: How to use "Cross Apply" in T-SQL? (XML document column filter and retrieve
  )
date: '2013-10-20T14:24:00.000-07:00'
author: Sandy Chan
tags:
- SQL
comments   : true
signature  : true
modified_time: '2013-10-20T14:41:56.769-07:00'
blogger_id: tag:blogger.com,1999:blog-6573336926514263825.post-4455302500037145066
blogger_orig_url: http://sandydychan.blogspot.com/2013/10/how-to-use-cross-apply-in-t-sql-xml.html
---

<h3>Introduction&nbsp;</h3>I used to know cross apply for a while but never find it useful until recently I was trying to solve an issue related to XML. "Cross Apply" does help to simplify the solution.<br /><h3>Background&nbsp;</h3>I have a table contains a<i> NVARCHAR(MAX) </i>column called "<b>[Document]</b>", the column always contains XML. We should use XML type but for some reason we didn't. Anyways, this article is about how to extract content from XML and also filter by the content in the XML.<br /><br />Let's say the table "<i>Inventory</i>" is like this<br /><br /><table style="border: 1px solid black;"><tbody><tr><td style="border: 1px solid black;">Id</td><td style="border: 1px solid black;">Document</td></tr><tr><td style="border: 1px solid black;">001</td><td style="border: 1px solid black;">&lt;Inventory&gt;<br />...</td></tr><tr><td style="border: 1px solid black;">002</td><td style="border: 1px solid black;">&lt;Inventory&gt;<br />...</td></tr><tr><td style="border: 1px solid black;">003</td><td style="border: 1px solid black;">&lt;Inventory&gt;<br />...</td></tr></tbody></table><br /><br /><h3>Using the code&nbsp;</h3>First of all, the XML column has content similar to this.<br /><br /><i>&lt;Inventory&gt;</i><br /><i><span class="Apple-tab-span" style="white-space: pre;"> </span>&lt;Products type="citrus"&gt;</i><br /><i><span class="Apple-tab-span" style="white-space: pre;"> </span><span class="Apple-tab-span" style="white-space: pre;"> </span>&lt;Product&gt;navel orange&lt;/Product&gt;</i><br /><i><span class="Apple-tab-span" style="white-space: pre;"> </span><span class="Apple-tab-span" style="white-space: pre;"> </span>&lt;Product&gt;valencia orange&lt;/Product&gt;</i><br /><i><span class="Apple-tab-span" style="white-space: pre;"> </span>&lt;/Products&gt;</i><br /><i><span class="Apple-tab-span" style="white-space: pre;"> </span>&lt;Products type="apple"&gt;</i><br /><i><span class="Apple-tab-span" style="white-space: pre;"> </span><span class="Apple-tab-span" style="white-space: pre;"> </span>&lt;Product&gt;fuji apple&lt;/Product&gt;</i><br /><i><span class="Apple-tab-span" style="white-space: pre;"> </span><span class="Apple-tab-span" style="white-space: pre;"> </span>&lt;Product&gt;empire apple&lt;/Product&gt;</i><br /><i><span class="Apple-tab-span" style="white-space: pre;"> </span>&lt;/Products&gt;</i><br /><i>&lt;/Inventory&gt;</i><br /><br />The problem we were trying to solve is to extract all <i>&lt;Product&gt;</i> innerText in citrus from all XML document. Surely this could be accomplished by <b>CURSOR</b>. But is there any better ways doing this? <b>CROSS APPLY</b>... Here is the query I've come up with.<br /><br /><i>SELECT&nbsp;XInventory.[Id] as Id, T.c.value('.', 'NVARCHAR(500)') AS ProductName</i><br /><i>FROM (SELECT [Id], CAST([Document] as XML) as XmlDocument FROM [Inventory]) XInventory</i><br /><i><b>CROSS APPLY</b> XmlDocument.nodes('//Products[@type="citrus"]/Product/text()') T(c) &nbsp;</i><br /><i>WHERE XmlDocument.exist('//Products[@type="citrus"]') = 1</i><br /><br />At the end, just found that WHERE clause is not needed as it is filtered by the XQuery in nodes(). So this is the ultimate solution.<br /><br /><i>SELECT&nbsp;XInventory.[Id] as Id, T.c.value('.', 'NVARCHAR(500)') AS ProductName</i><br /><i>FROM (SELECT [Id], CAST([Document] as XML) as XmlDocument FROM [Inventory]) XInventory</i><br /><i><b>CROSS APPLY </b>XmlDocument.nodes('//Products[@type="citrus"]/Product/text()') T(c) &nbsp;</i><br /><br />The trick is that Document column returns multiple records, and CROSS APPLY takes the record and apply content extraction. at the end, all <i>&lt;Product&gt;</i> innerText within<i> &lt;Products[@type="citrus"]&gt;</i>&nbsp;are returned.<br /><br />for more details: <a href="http://technet.microsoft.com/en-us/library/ms175156(v=sql.105).aspx" target="_blank">Using APPLY in MSDN</a>